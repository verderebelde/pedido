<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwfBXkzbREIu-IvJtcDnKJtLoHGHdrUc_2X7aOokYXXq79joy9YXvSbZB01K7XvgEEg/exec";
let productos = [];

fetch(API_URL + "?action=productos")
.then(r => r.json())
.then(data => {
  productos = data;
  const cont = document.getElementById("productos");
  cont.innerHTML = "";

  let categorias = {};
  data.forEach((p,i)=>{
    if(!categorias[p.categoria]) categorias[p.categoria] = [];
    categorias[p.categoria].push({...p,id:i});
  });

  for (let cat in categorias){
    cont.innerHTML += `<div class="categoria">${cat}</div>`;
    categorias[cat].forEach(p=>{
      cont.innerHTML += `
        <div class="producto">
          <div>${p.nombre}<br><small>${p.formato} - ${p.precio}</small></div>
          <input type="number"
                 id="p${p.id}"
                 min="0"
                 step="${p.salto}"
                 value="0"
                 onblur="validarMinimo(${p.id})"
                 oninput="calcular()">
        </div>`;
    });
  }
});

function validarMinimo(id){
  const input = document.getElementById("p"+id);
  const p = productos[id];
  let val = parseFloat(input.value) || 0;

  if(val > 0 && val < p.minimo){
    input.value = p.minimo;
  }

  // Ajustar al múltiplo del salto
  val = parseFloat(input.value) || 0;
  if(p.salto > 0){
    input.value = (Math.round(val / p.salto) * p.salto).toFixed(2);
  }

  calcular();
}

function calcular(){
  let t=0;
  productos.forEach((p,i)=>{
    const c=parseFloat(document.getElementById("p"+i)?.value)||0;
    t+=c*p.precioNum;
  });
  document.getElementById("total").innerText=t.toFixed(2)+" €";
}

function enviarPedido(){
  const nombre=document.getElementById("nombre").value.trim();
  const tel=document.getElementById("telefono").value.trim();

  if(!nombre || !tel){ alert("Completa nombre y teléfono"); return; }

  let sel=[];
  productos.forEach((p,i)=>{
    const c=parseFloat(document.getElementById("p"+i).value)||0;
    if(c>0) sel.push({producto:p.nombre, formato:p.formato, cantidad:c});
  });

  if(sel.length===0){ alert("No seleccionaste productos"); return; }

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({nombre, telefono:tel, productos:sel, total:document.getElementById("total").innerText}),
    headers:{"Content-Type":"application/json"}
  })
  .then(r=>r.json())
  .then(()=>{
    alert("✅ Pedido enviado correctamente");
    location.reload();
  })
  .catch(()=>alert("❌ Error enviando pedido"));
}
</script>