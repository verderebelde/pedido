<!DOCTYPE html>
<html>
<head>
  <base target="_top">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <style>
    body { font-family: Arial, sans-serif; padding: 20px; background: #f9f9f9; }
    .categoria-titulo { margin-top: 20px; padding: 8px; font-weight: bold; color: #fff; border-radius: 4px; }
    .categoria-VERDURAS { background-color: #4caf50; }
    .categoria-FRUTAS { background-color: #ff9800; }
    .categoria-LACTEOS { background-color: #2196f3; }
    .categoria-OTROS { background-color: #9c27b0; }
    .producto-row { display: flex; align-items: center; justify-content: space-between; background: white; padding: 10px; border-bottom: 1px solid #eee; }
    .producto-info { flex: 1; }
    .producto-row input { width: 70px; padding: 8px; text-align: center; border: 1px solid #ddd; }
    .total-container { margin-top: 20px; padding: 15px; background: #fff; border-top: 3px solid #4caf50; text-align: right; }
    .nota-pie { margin-top: 15px; font-style: italic; color: #d35400; font-weight: bold; text-align: center; }
    button { background: #4caf50; color: white; padding: 15px; width: 100%; border: none; font-size: 18px; cursor: pointer; border-radius: 5px; }
    input[type="text"], input[type="tel"] { width: 100%; padding: 12px; margin-bottom: 10px; border: 1px solid #ccc; border-radius: 4px; box-sizing: border-box; }
  </style>
</head>
<body>

<h2>Pedido Online</h2>
<input type="text" id="nombre" placeholder="Nombre completo (obligatorio)">
<input type="tel" id="telefono" placeholder="Número de teléfono (obligatorio)">

<div id="productos">Cargando...</div>

<div class="total-container">
  <strong>Total: <span id="total">0,00 €</span></strong>
  <button id="btnEnviar" onclick="enviarPedido()">Enviar y Confirmar WhatsApp</button>
</div>

<div class="nota-pie">"Se pide por unidad, se pone por kg"</div>

<script>
let productosGlobal = [];
const MI_TELEFONO_RECEPCION = "34644406366"; // <-- TU NÚMERO
const API_URL = "https://script.google.com/macros/s/AKfycbxxxxxxxxxxxx/exec"; // <-- TU WEB APP URL

// Cargar productos desde Apps Script
window.onload = () => {
  google.script.run.withSuccessHandler(datos => {
    productosGlobal = datos;
    const cont = document.getElementById("productos");
    cont.innerHTML = "";
    let cats = {};
    datos.forEach((p,i) => {
      if (!cats[p.categoria]) cats[p.categoria] = [];
      cats[p.categoria].push({...p, id: i});
    });
    for (let c in cats) {
      cont.innerHTML += `<div class="categoria-titulo categoria-${c}">${c}</div>`;
      cats[c].forEach(p => {
        cont.innerHTML += `<div class="producto-row">
          <div class="producto-info"><strong>${p.nombre}</strong><br><small>${p.formato} - ${p.precio}</small></div>
          <input type="number" id="prod_${p.id}" step="${p.salto}" min="0" value="0" onchange="ajustarMinimo(this, ${p.minimo})" oninput="calcularTotal()">
        </div>`;
      });
    }
  }).obtenerProductos();
};

function ajustarMinimo(input, min) {
  let val = parseFloat(input.value);
  if (val > 0 && val < min) { input.value = min; calcularTotal(); }
}

function calcularTotal() {
  let t = 0;
  productosGlobal.forEach((p,i) => {
    let cant = parseFloat(document.getElementById("prod_" + i).value) || 0;
    t += cant * p.precioNum;
  });
  document.getElementById("total").innerText = t.toFixed(2).replace(".",",") + " €";
  return t.toFixed(2);
}

function enviarPedido() {
  const n = document.getElementById("nombre").value.trim();
  const tel = document.getElementById("telefono").value.trim();
  const btn = document.getElementById("btnEnviar");
  
  if (!n || !tel) { alert("Nombre y teléfono son obligatorios"); return; }
  
  let sel = [];
  let textoWhatsApp = `*Nuevo Pedido*\n*Cliente:* ${n}\n*Tel:* ${tel}\n----------\n`;
  
  productosGlobal.forEach((p,i) => {
    let cant = parseFloat(document.getElementById("prod_" + i).value) || 0;
    if (cant > 0) {
      sel.push({producto: p.nombre, formato: p.formato, cantidad: cant });
      textoWhatsApp += `- ${cant}x ${p.nombre} (${p.formato})\n`;
    }
  });
  
  if (sel.length === 0) { alert("No has seleccionado productos"); return; }
  
  textoWhatsApp += `----------\n*Total: ${document.getElementById("total").innerText}*`;
  btn.disabled = true;
  btn.innerText = "Registrando...";

  // Guardar en Google Sheets y luego abrir WhatsApp
  google.script.run.withSuccessHandler(() => {
    const url = "https://api.whatsapp.com/send?phone=" + MI_TELEFONO_RECEPCION + "&text=" + encodeURIComponent(textoWhatsApp);
    
    document.body.innerHTML = `
      <div style="text-align:center; padding:50px;">
        <h2>¡Casi listo!</h2>
        <p>Tu pedido se ha guardado en Google Sheets. Haz clic en el botón de abajo para enviarnos la confirmación por WhatsApp.</p>
        <a href="${url}" target="_blank" style="background:#25D366; color:white; padding:15px 25px; text-decoration:none; border-radius:5px; font-weight:bold; display:inline-block; margin-top:20px;">
          ENVIAR POR WHATSAPP
        </a>
      </div>`;
  }).enviarDatos({ 
    nombre: n, 
    telefono: tel, 
    productos: sel, 
    total: calcularTotal(),
    hoja: "PEDIDOS"
  });
}
</script>
</body>
</html>