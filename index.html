<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<title>Pedido Online</title>
<style>
body{font-family:Arial;padding:20px;background:#f5f5f5}
h2{margin-top:30px}
.producto{display:flex;justify-content:space-between;margin:5px 0;background:white;padding:8px;border-radius:6px}
input[type=number]{width:70px}
.total{font-size:22px;margin-top:20px}
button{padding:12px 20px;font-size:16px;background:green;color:white;border:none;border-radius:8px}
</style>
</head>
<body>

<h1>Hacer Pedido</h1>

Nombre: <input id="nombre"><br><br>
Teléfono: <input id="movil"><br><br>

<div id="productos"></div>

<div class="total">TOTAL: €<span id="total">0</span></div><br>
<button onclick="enviarPedido()">ENVIAR PEDIDO</button>

<script>
const API_URL = "https://script.google.com/macros/s/AKfycbyNQw_E454FTdYKsxugWrJTtInlGeOzZH2xvLT4-YatKUb0aKDNz3gtqxyIUC45tCFD/exec";
let productos = [];
let carrito = {};

fetch(API_URL + "?action=productos")
.then(r=>r.json())
.then(data=>{
  productos = data;
  mostrarProductos();
});

function mostrarProductos(){
  const cont = document.getElementById("productos");
  let categorias = {};

  productos.forEach((p,i)=>{
    if(!categorias[p.categoria]) categorias[p.categoria]=[];
    categorias[p.categoria].push({...p,id:i});
  });

  for(let cat in categorias){
    cont.innerHTML += `<h2>${cat}</h2>`;
    categorias[cat].forEach(p=>{
      cont.innerHTML += `
        <div class="producto">
          <div>${p.nombre} (${p.formato}) - €${p.precio}</div>
          <input type="number" min="0" step="${p.salto}" value="0"
            onchange="cambiarCantidad(${p.id}, this.value)">
        </div>`;
    });
  }
}

function cambiarCantidad(id, cantidad){
  const p = productos[id];
  cantidad = parseFloat(cantidad)||0;

  if(cantidad>0 && cantidad < p.minimo){
    alert("Mínimo para "+p.nombre+" es "+p.minimo);
    return;
  }

  carrito[id] = cantidad;
  calcularTotal();
}

function calcularTotal(){
  let total=0;
  for(let id in carrito){
    total += carrito[id]*productos[id].precio;
  }
  document.getElementById("total").innerText = total.toFixed(2);
}

function enviarPedido(){
  const nombre = document.getElementById("nombre").value;
  const movil = document.getElementById("movil").value;

  let resumen = "";
  let total = 0;

  for(let id in carrito){
    if(carrito[id]>0){
      let p = productos[id];
      resumen += `${carrito[id]} x ${p.nombre}\n`;
      total += carrito[id]*p.precio;
    }
  }

  fetch(API_URL,{
    method:"POST",
    body: JSON.stringify({nombre,movil,pedido:resumen,total})
  })
  .then(()=> {
    document.body.innerHTML = `
      <h1>GRACIAS POR TU PEDIDO</h1>
      <pre>${resumen}</pre>
      <h2>Total €${total.toFixed(2)}</h2>
    `;
  });
}
</script>
</body>
</html>