<script>
// IMPORTANTE: Cambia esta URL por la tuya que termine en /exec
const API_URL = "https://script.google.com/macros/s/AKfycby4ngt5wn_NqzAXYt0tgno-g91dQu6Mjoy2ptE0a5wMZdMn3lpy60RQOu1xyHb_96_3/exec"; 
let productos = [];

// Cargar productos
fetch(API_URL + "?action=productos")
.then(r => r.json())
.then(data => {
  productos = data;
  const cont = document.getElementById("productos");
  cont.innerHTML = "";
  let categorias = {};

  data.forEach((p, i) => {
    if(!categorias[p.categoria]) categorias[p.categoria] = [];
    categorias[p.categoria].push({...p, id: i});
  });

  for (let cat in categorias){
    cont.innerHTML += `<div class="categoria">${cat}</div>`;
    categorias[cat].forEach(p => {
      cont.innerHTML += `
      <div class="producto">
        <div>${p.nombre}<br><small>${p.formato} - ${p.precio}</small></div>
        <input type="number" id="p${p.id}" min="0" step="${p.salto}" value="0" 
               onchange="validarMinimo(${p.id})" oninput="calcular()">
      </div>`;
    });
  }
})
.catch(err => {
  document.getElementById("productos").innerText = "❌ Error al cargar. Asegúrate de haber publicado como 'Cualquiera'.";
});

function validarMinimo(id){
  const input = document.getElementById("p" + id);
  const p = productos[id];
  let val = parseFloat(input.value) || 0;
  if(val > 0 && val < p.minimo) val = p.minimo;
  // Ajustar al salto más cercano
  if(p.salto > 0) val = Math.ceil(val / p.salto) * p.salto;
  input.value = val;
  calcular();
}

function calcular(){
  let t = 0;
  productos.forEach((p, i) => {
    const input = document.getElementById("p" + i);
    const c = input ? parseFloat(input.value) || 0 : 0;
    t += c * p.precioNum;
  });
  document.getElementById("total").innerText = t.toFixed(2) + " €";
}

function enviarPedido(){
  const btn = event.target;
  const nombre = document.getElementById("nombre").value.trim();
  const tel = document.getElementById("telefono").value.trim();
  const totalTxt = document.getElementById("total").innerText;

  if(!nombre || !tel) { alert("Completa nombre y teléfono"); return; }

  let sel = [];
  productos.forEach((p, i) => {
    const input = document.getElementById("p" + i);
    const c = input ? parseFloat(input.value) || 0 : 0;
    if(c > 0) sel.push({nombre: p.nombre, formato: p.formato, cantidad: c});
  });

  if(sel.length === 0) { alert("El pedido está vacío"); return; }

  btn.disabled = true;
  btn.innerText = "Enviando...";

  // Para evitar errores de CORS, enviamos como text/plain pero con estructura JSON
  fetch(API_URL, {
    method: "POST",
    mode: "no-cors", // Google Script requiere esto a veces desde dominios externos
    body: JSON.stringify({nombre: nombre, telefono: tel, productos: sel, total: totalTxt})
  })
  .then(() => {
    // Como usamos 'no-cors', no podemos leer la respuesta JSON, 
    // pero si no hay error, asumimos que se envió.
    mostrarResumen(nombre, tel, sel, totalTxt);
  })
  .catch(err => {
    alert("Error de conexión");
    btn.disabled = false;
  });
}

function mostrarResumen(nombre, tel, sel, total) {
  document.body.innerHTML = `
    <div style="text-align:center; padding:20px;">
      <h2>¡Gracias por tu pedido!</h2>
      <p>Tu pedido se ha registrado correctamente.</p>
      <div style="text-align:left; background:#fff; padding:15px; border-radius:8px; display:inline-block;">
        <p><strong>Cliente:</strong> ${nombre}</p>
        <p><strong>Teléfono:</strong> ${tel}</p>
        <hr>
        <p><strong>Detalle:</strong></p>
        <ul>${sel.map(p => `<li>${p.nombre} (${p.formato}) x ${p.cantidad}</li>`).join("")}</ul>
        <p style="font-size:1.2em"><strong>Total: ${total}</strong></p>
      </div>
      <br><br>
      <button onclick="location.reload()">Nuevo Pedido</button>
    </div>`;
}
</script>