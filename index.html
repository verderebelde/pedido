<!DOCTYPE html>
<html>
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>Pedido Online</title>

<style>
body { font-family: Arial; padding: 20px; background:#f9f9f9 }
.categoria { margin-top:20px; font-weight:bold }
.producto { display:flex; justify-content:space-between; margin-bottom:8px; background:#fff; padding:8px }
input { width:70px; padding:6px; text-align:center }
button { padding:14px; width:100%; background:#4caf50; color:#fff; border:none; font-size:16px }
.total { margin-top:15px; font-size:18px }
</style>
</head>

<body>

<h2>Pedido Online</h2>

<input type="text" id="nombre" placeholder="Nombre completo" style="width:100%; padding:10px; margin-bottom:8px">
<input type="tel" id="telefono" placeholder="Tel√©fono" style="width:100%; padding:10px; margin-bottom:15px">

<div id="productos">Cargando productos...</div>

<div class="total">Total: <strong><span id="total">0.00 ‚Ç¨</span></strong></div>
<br>
<button onclick="enviarPedido()">Enviar Pedido</button>

<!-- üî• EL SCRIPT VA JUSTO ANTES DE CERRAR BODY -->
<script>
const API_URL = "https://script.google.com/macros/s/AKfycbwZsQGaRjuR4wLU3pncE1RkvRBunOAF8UxUQ-TRDaAxUq_LUaclygcPbKmwtV_HRMCJ/exec";
let productos = [];

fetch(API_URL + "?action=productos")
.then(r => r.json())
.then(data => {
  productos = data;
  const cont = document.getElementById("productos");
  cont.innerHTML = "";

  let categorias = {};
  data.forEach((p,i)=>{
    if(!categorias[p.categoria]) categorias[p.categoria] = [];
    categorias[p.categoria].push({...p,id:i});
  });

  for (let cat in categorias){
    cont.innerHTML += `<div class="categoria">${cat}</div>`;
    categorias[cat].forEach(p=>{
      cont.innerHTML += `
        <div class="producto">
          <div>${p.nombre}<br><small>${p.formato} - ${p.precio}</small></div>
          <input type="number"
                 id="p${p.id}"
                 min="0"
                 step="${p.salto}"
                 value="0"
                 onblur="validarMinimo(${p.id})"
                 oninput="calcular()">
        </div>`;
    });
  }
})
.catch(err=>{
  document.getElementById("productos").innerHTML = "‚ùå Error cargando productos";
  console.error(err);
});

function validarMinimo(id){
  const input = document.getElementById("p"+id);
  const p = productos[id];
  let val = parseFloat(input.value) || 0;

  if(val > 0 && val < p.minimo){
    val = p.minimo;
  }

  if(p.salto > 0){
    val = Math.round(val / p.salto) * p.salto;
  }

  input.value = val.toFixed(2);
  calcular();
}

function calcular(){
  let t=0;
  productos.forEach((p,i)=>{
    const c=parseFloat(document.getElementById("p"+i)?.value)||0;
    t+=c*p.precioNum;
  });
  document.getElementById("total").innerText=t.toFixed(2)+" ‚Ç¨";
}

function enviarPedido(){
  const nombre=document.getElementById("nombre").value.trim();
  const tel=document.getElementById("telefono").value.trim();

  if(!nombre || !tel){ alert("Completa nombre y tel√©fono"); return; }

  let sel=[];
  productos.forEach((p,i)=>{
    const c=parseFloat(document.getElementById("p"+i).value)||0;
    if(c>0) sel.push({producto:p.nombre, formato:p.formato, cantidad:c});
  });

  if(sel.length===0){ alert("No seleccionaste productos"); return; }

  fetch(API_URL,{
    method:"POST",
    body:JSON.stringify({nombre, telefono:tel, productos:sel, total:document.getElementById("total").innerText}),
    headers:{"Content-Type":"application/json"}
  })
  .then(r=>r.json())
  .then(()=>{
    alert("‚úÖ Pedido enviado correctamente");
    location.reload();
  })
  .catch(()=>alert("‚ùå Error enviando pedido"));
}
</script>

</body>
</html>